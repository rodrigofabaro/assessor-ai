generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubmissionStatus {
  UPLOADED
  EXTRACTING
  EXTRACTED
  NEEDS_OCR
  ASSESSING
  MARKING
  DONE
  FAILED
}

enum ExtractionStatus {
  PENDING
  RUNNING
  DONE
  NEEDS_OCR
  FAILED
}

enum ReferenceDocumentType {
  SPEC
  BRIEF
  RUBRIC
}

enum ReferenceDocumentStatus {
  UPLOADED
  EXTRACTED
  REVIEWED
  LOCKED
  FAILED
}

enum RecordStatus {
  DRAFT
  LOCKED
}

enum MapSource {
  AUTO_FROM_BRIEF
  MANUAL_OVERRIDE
}

enum GradeBand {
  PASS
  MERIT
  DISTINCTION
}

model Student {
  id         String   @id @default(uuid())
  name       String
  studentRef String? // optional: your internal ID / reg number
  email      String? @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  submissions Submission[]
}

model Assignment {
  id            String   @id @default(uuid())
  unitCode      String   // e.g. "4017"
  title         String   // e.g. "Quality Control Tools and Costing"
  assignmentRef String?  // e.g. "A1", "A2"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Phase 2.5 bindings (lock state for criteria/brief binding)
  bindingStatus   String?   // e.g. "DRAFT" | "READY" | "LOCKED"
  bindingLockedBy String?
  bindingLockedAt DateTime?

  // Phase 2 linkage: operational assignments can reference a locked brief (A1/A2...)
  assignmentBriefId String?
  assignmentBrief   AssignmentBrief? @relation(fields: [assignmentBriefId], references: [id])

  submissions Submission[]

  @@index([assignmentBriefId])
}

model Submission {
  id             String           @id @default(uuid())
  filename       String
  storedFilename String
  storagePath    String           // local path for dev; later becomes object storage key/url
  status         SubmissionStatus @default(UPLOADED)

  uploadedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations (Inbox mode: optional at upload time)
  studentId    String?
  assignmentId String?
  student      Student?    @relation(fields: [studentId], references: [id])
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])

  @@index([studentId])
  @@index([assignmentId])


  // Extraction output (Phase 3)
  extractedText   String?
  extractionRuns  SubmissionExtractionRun[]
  assessments     Assessment[]
}

model SubmissionExtractionRun {
  id                String           @id @default(uuid())
  status            ExtractionStatus @default(PENDING)
  isScanned         Boolean          @default(false)
  overallConfidence Float            @default(0)
  engineVersion     String           @default("extract-v1")

  pageCount  Int?
  sourceMeta Json?
  warnings   Json?
  error      String?

  startedAt  DateTime @default(now())
  finishedAt DateTime?
  updatedAt  DateTime @updatedAt

  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id])

  pages ExtractedPage[]

  @@index([submissionId])
}

model ExtractedPage {
  id         String @id @default(uuid())
  pageNumber Int
  text       String
  confidence Float  @default(0)
  width      Float?
  height     Float?

  // Stored as an array of {text,x,y,w,h} for later annotation.
  tokens Json?

  extractionRunId String
  extractionRun   SubmissionExtractionRun @relation(fields: [extractionRunId], references: [id])

  @@unique([extractionRunId, pageNumber])
  @@index([extractionRunId])
}

model Assessment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Core output (later)
  overallGrade String?
  feedbackText String?
  resultJson   Json?

  // Files (later)
  annotatedPdfPath String?

  // Relations
  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id])
}

model ReferenceDocument {
  id               String                  @id @default(uuid())
  type             ReferenceDocumentType
  status           ReferenceDocumentStatus @default(UPLOADED)
  title            String
  version          Int                     @default(1)
  originalFilename String
  storedFilename   String
  storagePath      String
  checksumSha256   String
  uploadedAt       DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  // Extraction + review (Phase 2.2)
  extractedJson      Json?
  extractionWarnings Json?
  sourceMeta         Json?
  lockedAt           DateTime?
  lockedBy           String?

  // Relations
  unitsAsSpec Unit[]            @relation("SpecDocUnits")
  briefsAsDoc AssignmentBrief[] @relation("BriefDocBriefs")
}

model Unit {
  id        String       @id @default(uuid())
  unitCode  String
  unitTitle String
  status    RecordStatus @default(DRAFT)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Useful spec labels (e.g. "Issue 5 â€“ June 2025")
  specIssue        String?
  specVersionLabel String?
  lockedAt         DateTime?
  lockedBy         String?

  // Spec doc
  specDocumentId String?
  specDocument   ReferenceDocument? @relation("SpecDocUnits", fields: [specDocumentId], references: [id])

  learningOutcomes LearningOutcome[]
  assignmentBriefs AssignmentBrief[]
}

model LearningOutcome {
  id               String   @id @default(uuid())
  loCode           String   // e.g. "LO1"
  description      String
  essentialContent String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id])

  criteria AssessmentCriterion[]

  @@unique([unitId, loCode])
}

model AssessmentCriterion {
  id          String   @id @default(uuid())
  acCode      String   // e.g. "P1", "M2", "D1"
  gradeBand   GradeBand
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  learningOutcomeId String
  learningOutcome   LearningOutcome @relation(fields: [learningOutcomeId], references: [id])

  assignmentMaps AssignmentCriterionMap[]

  @@unique([learningOutcomeId, acCode])
}

model AssignmentBrief {
  id               String       @id @default(uuid())
  assignmentCode   String       // e.g. "A1"
  title            String
  status           RecordStatus @default(DRAFT)
  assignmentNumber Int?
  totalAssignments Int?
  aiasLevel        Int?
  lockedAt         DateTime?
  lockedBy         String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id])

  briefDocumentId String?
  briefDocument   ReferenceDocument? @relation("BriefDocBriefs", fields: [briefDocumentId], references: [id])

  criteriaMaps AssignmentCriterionMap[]
  assignments  Assignment[] // operational assignments can point here

  @@unique([unitId, assignmentCode])
}

model AssignmentCriterionMap {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  source     MapSource @default(AUTO_FROM_BRIEF)
  confidence Float?    @default(1)

  assignmentBriefId      String
  assessmentCriterionId  String

  assignmentBrief     AssignmentBrief     @relation(fields: [assignmentBriefId], references: [id])
  assessmentCriterion AssessmentCriterion @relation(fields: [assessmentCriterionId], references: [id])

  @@unique([assignmentBriefId, assessmentCriterionId])
}
